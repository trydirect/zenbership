FROM php:7.3-fpm

MAINTAINER Vasili Pascal <info@optimum-web.com>

RUN apt-get update && apt-get install -y \
        procps \
        libmcrypt-dev \
        libzip-dev \
        zlib1g-dev \
        cron \
        mcrypt \
        libcurl4-openssl-dev \
        libbz2-dev \
        libgd-dev \
        libfreetype6-dev \
		libjpeg62-turbo-dev \
        wget \
        net-tools \
        tcpdump \
        unzip \
        cron \
        pkg-config \
        build-essential \
        libmemcached-dev \
		libpng-dev \
		supervisor \
    && docker-php-ext-install -j$(nproc) zip pdo_mysql mysqli gd curl && rm -r /usr/local/etc/php-fpm.d/*

RUN pecl install mcrypt-1.0.2 && docker-php-ext-enable mcrypt
#RUN echo "extension=mcrypt.so" | tee -a /usr/local/etc/php/conf.d/mcrypt.ini

RUN pecl install memcached-3.1.3 && docker-php-ext-enable memcached
#RUN echo "extension=memcached.so" >> /usr/local/etc/php/conf.d/ext-memcache.ini

COPY ./configs/php/fpm/php.ini /usr/local/etc/php/
COPY ./configs/php/php-fpm.d/www.conf /usr/local/etc/php-fpm.d/www.conf

# unpack src to docroot
ADD ./src/zenbership-115.tar.gz /var/www/html/

# add source code gzip to src
COPY ./src/zenbership-115.tar.gz /usr/src

COPY ./preinstall.sh /tmp
COPY ./postinstall.sh /tmp

WORKDIR /var/www/html/zenbership-115

COPY ./configs/supervisor/supervisord.conf /etc/supervisord.conf
# generated by install wizard, must be copied to host machine
#COPY ./configs/config.php /var/www/html/zenbership-115/admin/sd-system

CMD ["/usr/bin/supervisord -n -c /etc/supervisord.conf"]
EXPOSE 9000
